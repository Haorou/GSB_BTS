
@{
    ViewBag.Title = "Echantillon";
}

<h2>Echantillon</h2>


<div class="container">
    <h2 id="employe" data-id="@ViewBag.Employe.Id">Bienvenue @ViewBag.Employe.Prenom @ViewBag.Employe.Nom</h2>
    <p>@ViewBag.Employe.Nom : vous avez eu un rendez-vous avec :</p>
    <table class="table table-hover">
        <thead>
            <tr>
                <th class="modal_RDV_form">Praticien</th>
                <th class="modal_RDV_form">Date RDV</th>
                <th class="modal_RDV_form">Heure RDV</th>
                <th class="modal_RDV_form">Date Bilan</th>
                <th class="modal_RDV_form">Enchantillons donnés</th>
            </tr>

        </thead>
        <tbody>
            @{
                var passeRDV = ViewBag.RendezVous;

                var dateRDV = passeRDV.Date_rdv.ToShortDateString();
                var heureRDV = passeRDV.Date_rdv.ToShortTimeString();
                var dateBilan = passeRDV.Date_bilan.ToShortDateString();

                <tr>
                    <th class="modal_RDV_form">@passeRDV.Praticien.Nom</th>
                    <th class="modal_RDV_form">@dateRDV</th>
                    <th class="modal_RDV_form">@heureRDV</th>
                    <th class="modal_RDV_form">@dateBilan</th>
                    <th class="modal_RDV_form">@passeRDV.Liste_echantillons_donnes.Count</th>
                </tr>
            }
        </tbody>
    </table>
    <h2>Liste echantillons donnees</h2>
    <p>@ViewBag.Employe.Nom : vous avez donné :</p>
    <table class="table table-hover">
        <thead>
            <tr>
                <td>
                    <button type="submit" class="btn btn-warning" name="retour" onclick="history.go(-1)">
                        <span class="glyphicon glyphicon-backward"></span> Retour
                    </button>
                </td>
                <td>
                    <button type="submit" class="btn btn-primary buttonModal" data-toggle="modal" data-target="#EDModal" data-action="add"><span class="glyphicon glyphicon-plus-sign"></span>Ajouter</button>
                </td>
                <td>
                    <button type="submit" class="btn btn-success buttonModal" data-toggle="modal" data-target="#EDModal" data-action="modify"><span class="glyphicon glyphicon-edit"></span>Modifier</button>
                </td>
                <td>
                    <button type="submit" class="btn btn-warning" id="eraseED" data-toggle="modal"><span class="glyphicon glyphicon-trash"></span>Supprimer</button>
                </td>
            </tr>
            <tr>
                <th class="modal_RDV_form">Choix</th>
                <th class="modal_RDV_form">Famille</th>
                <th class="modal_RDV_form">Nom</th>
                <th class="modal_RDV_form">Quantite</th>
                <th class="modal_RDV_form">Concentration</th>
            </tr>
        </thead>
        <tbody>
            @{
                var mesEchantillonDonne = ViewBag.Echantillon;
                int tailleMesEchantillonDonne = mesEchantillonDonne.Count;
                if (tailleMesEchantillonDonne != 0)
                {
                    for (int index = 0; index < tailleMesEchantillonDonne; index++)
                    {
                        <tr>
                            <th class="modal_RDV_form">
                                <input checked type="radio" aria-label="" name="echantillon_donne_radio" value="@mesEchantillonDonne[index].RendezVous.Id_rdv|@mesEchantillonDonne[index].Echantillon.Id_echantillon" data-id="@mesEchantillonDonne[index].RendezVous.Id_rdv|@mesEchantillonDonne[index].Echantillon.Id_echantillon">
                            </th>
                            <th class="modal_RDV_form">@mesEchantillonDonne[index].Produit.Famille</th>
                            <th class="modal_RDV_form">@mesEchantillonDonne[index].Produit.Nom</th>
                            <th class="modal_RDV_form">@mesEchantillonDonne[index].Quantite</th>
                            <th class="modal_RDV_form">@mesEchantillonDonne[index].Echantillon.Concentration</th>
                        </tr>
                    }

                }

                else
                {
                    <tr>
                        <th colspan="7" style="text-align: center;">Vous n'avez donné aucun échantillon</th>
                    </tr>
                }
            }
        </tbody>
    </table>


    <div class="modal fade" id="EDModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Echantillons Données</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label for="famille" class="col-form-label">Famille:</label>
                            <select class="browser-default custom-select" id="select_famille">
                                <option value="Choisir une famille" selected>Choisir une famille</option>
                                @{
                                    var mesFamilles = ViewBag.Famille;
                                    foreach (var famille in mesFamilles)
                                    {
                                        <option value="@famille.Famille">@famille.Famille</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="text" class="col-form-label">Medicament:</label>
                            <select class="browser-default custom-select" id="medicament">
                                <option value="Choisir un medicament" selected>Choisir un medicament</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <div class='col-sm-6' id="col-sm-6_ED">
                                <input for="text" class="form-control" placeholder="Quantité">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class='col-sm-6' id="col-sm-6_ED">
                                <div class="form-group">
                                    <input for="text" class="form-control" placeholder="Concentration">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>


            </div>
            <div class="modal-footer">
                <button type="button" id="send_ED" class="btn btn-success" data-action="add"><span class="glyphicon glyphicon-ok"></span>Envoyer</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
@section scripts {
    <script type="text/javascript">

        $('#select_famille').change(function () {
            var famille = $(this).val();

            try {
                $.ajax({ // Plusieurs éléments sont attendus pour une requête Ajax : TYPE / URL / DATA
                    type: "POST",
                    url: "/Commercial/AjaxProduitFromFamille",
                    data: 'famille=' + famille,
                }).then(function (response) { // Then fonctionne uniquement après que la fonction C# est renvoyé quelque chose
                    var JsonResponse = JSON.parse(response);

                    $('#medicament').empty();

                    $.each(JsonResponse, function (key, value) {
                        html = "<option value="+ value.Id +">" + value.Nom + "</option>";
                        $('#medicament').append(html);
                    })
                });
            }
            catch (ex) {
                alert("catch Ajax Error" + ex);
            }
        });
        
        $('.buttonModal').click(function () {
            console.log("hello");
        });

        $('.buttonModal').click(function () { // Bouton Ajouter / Modifier Click

            var action = $(this).data('action'); // data-action="modify" OU "add"
            var modal = $('#EDModal'); // ModalHTML du RDV
            var id_echantillon_donne = $("input[name='echantillon_donne_radio']:checked").data('id'); // Bouton radio -> data-id="X"

            if (action === 'modify') {
                $('#send_ED').data('action', 'modify'); // Permet de changer le rôle du bouton "Ajouter" au sein du modal
                try {

                    $.ajax({ // Plusieurs éléments sont attendus pour une requête Ajax : TYPE / URL / DATA
                        type: "POST",
                        url: "/Commercial/AjaxReader",
                        data: 'table=' + "rendez_vous" + '&id=' + id_rdv,
                    }).then(function (response) { // Then fonctionne uniquement après que la fonction C# est renvoyé quelque chose
                        var JsonResponse = JSON.parse(response);

                        $("#select_praticien").val(JsonResponse.Praticien.Id);
                        $("#select_praticien").attr('disabled', true); // Ajoute Readonly "fixe la valeur" a un Input - Ici select_praticien

                        var milli = JsonResponse.Date_rdv.replace(/\/Date\((-?\d+)\)\//, '$1');
                        var date = new Date(parseInt(milli));

                        var dateAmericanFormat = date.toISOString();
                        var timeLocalFormat = date.toLocaleTimeString();

                        $('#date_rdv').val(dateAmericanFormat.substring(0, 10));
                        $('#time_rdv').val(timeLocalFormat.substring(0, 5));
                        $('#motif_rdv').val(JsonResponse.Motif_rdv);
                        $('#indice_confiance').val(JsonResponse.Indice_confiance);

                        modal.find('.modal-title').text('Rendez-Vous avec ' + JsonResponse.Praticien.Nom);
                    });
                }
                catch (ex) {
                    alert("catch Ajax Error" + ex);
                }

                modal.find('.modal-body input').val(id_rdv);
            }
            else if (action === 'add') {
                $('#send_ED').data('action', 'add');

                $("#select_famille").val("Choisir une Famille");
                modal.find('.modal-title').text('Nouvel echantillon Donne');
                $("#select_famille").attr('disabled', false);

                var date = new Date($.now());
                var dateAmericanFormat = date.toISOString();
                var timeLocalFormat = date.toLocaleTimeString();

                $('#date_rdv').val(dateAmericanFormat.substring(0, 10));
                $('#time_rdv').val(timeLocalFormat.substring(0, 5));
                $('#motif_rdv').val("Choisir un motif");
                $('#indice_confiance').val(1);
            }

        });

         // Le bouton "ENVOYER" a la fin du modal (son data-action change au dessus avec bouton Modal)
        $('#send_ED').click(function () {
            var date = $('#date_rdv').val();
            var time = $('#time_rdv').val();
            var motif = $('#motif_rdv').val();
            var indice = $('#indice_confiance').val();
            var id_praticien = $('#select_praticien').val();
            var id_employe = $('#employe').data('id');

            var action = $('#send_RDV').data('action');

            if (action == 'add') {
                try {
                    $.ajax({
                        type: "POST",
                        url: "/Commercial/AjaxAddModifyRDV",
                        data: "id=" + '' + "&date=" + date + "&time=" + time + "&motif=" + motif + "&indice=" + indice + "&id_employe=" + id_employe + "&id_praticien=" + id_praticien,
                    }).then(function () {
                        location.reload();
                    });
                }
                catch (ex) {
                    alert("catch Ajax Error" + ex);
                }
            }
            else if (action == 'modify') {
                var id_rdv = $("input[name='echantillon_donne_radio']:checked").data('id');
                try {
                    $.ajax({
                        type: "POST",
                        url: "/Commercial/AjaxAddModifyRDV",
                        data: "id=" + id_rdv + "&date=" + date + "&time=" + time + "&motif=" + motif + "&indice=" + indice + "&id_employe=" + id_employe + "&id_praticien=" + id_praticien,
                    }).then(function () {
                        location.reload();
                    });
                }
                catch (ex) {
                    alert("catch Ajax Error" + ex);
                }
            }
        });

        $('#eraseED').click(function () {
            var id_ED = $("input[name='echantillon_donne_radio']:checked").data('id');
            if (id_ED != null) {
                $.ajax({
                    type: "POST",
                    url: "/Commercial/AjaxDelete",
                    data: "table=" + 'echantillon_donne' + "&id=" + id_ED,
                }).then(function () {
                    location.reload();
                });
            }
        });

    </script>

}